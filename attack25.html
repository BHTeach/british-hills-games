<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attack 25</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --grid-gap: 1vmin;
            --tile-color: #ffffff;
            --text-color: #333;
            --red: #e74c3c;
            --blue: #3498db;
            --green: #2ecc71;
            --yellow: #f1c40f;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Views */
        .view-section {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
        }
        .view-section.active { display: flex; }

        /* Start Menu */
        #start-menu {
            justify-content: center;
            gap: 20px;
            height: 100vh;
        }
        .menu-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 20px 40px;
            font-size: 24px;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            cursor: pointer;
            box-shadow: var(--shadow);
            font-weight: bold;
            color: #333;
        }
        .menu-btn:active { transform: scale(0.98); background: #eee; }
        .menu-btn.primary { background: var(--blue); color: white; border: none; }
        
        .team-selector {
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }
        .ts-btn {
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            font-size: 18px;
        }
        .ts-btn.selected { background: var(--blue); color: white; border-color: var(--blue); }

        /* Editor */
        #editor-view {
            padding: 20px;
            height: 100vh;
            overflow: hidden;
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }
        .editor-list {
            flex: 1;
            overflow-y: auto;
            width: 100%;
            max-width: 800px;
            padding-bottom: 50px;
        }
        .edit-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .edit-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .edit-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .edit-label { font-size: 12px; color: #777; width: 60px; padding-top: 10px;}

        /* Game Header */
        header {
            width: 95vmin;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            margin-bottom: 10px;
        }

        h1 { margin: 0; font-size: 24px; color: var(--text-color); }

        .icon-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .reset-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Scoreboard */
        #scoreboard {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            width: 95vmin;
            height: 60px;
            margin-bottom: 10px;
        }

        .score-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            color: white;
            box-shadow: var(--shadow);
            font-weight: bold;
            display: none; /* Hidden by default, shown via JS */
        }
        .score-card span { font-size: 12px; opacity: 0.9; }
        .score-card strong { font-size: 24px; }

        .sc-red { background-color: var(--red); }
        .sc-blue { background-color: var(--blue); }
        .sc-green { background-color: var(--green); }
        .sc-yellow { background-color: var(--yellow); color: #333; }

        /* Grid */
        #game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: var(--grid-gap);
            width: 90vmin;
            height: 90vmin;
            margin: 0 auto;
            background-color: #ddd;
            border: 1px solid #ccc;
            padding: var(--grid-gap);
            border-radius: 12px;
        }

        .tile {
            background-color: var(--tile-color);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4vmin;
            font-weight: bold;
            color: #ccc;
            cursor: pointer;
            box-shadow: var(--shadow);
            width: 100%;
            height: 100%;
            transition: transform 0.1s;
        }

        .tile:active { transform: scale(0.95); }
        .tile.taken { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .tile[data-color="red"] { background-color: var(--red); }
        .tile[data-color="blue"] { background-color: var(--blue); }
        .tile[data-color="green"] { background-color: var(--green); }
        .tile[data-color="yellow"] { background-color: var(--yellow); color: #333; text-shadow: none; }

        /* Modal */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 20px;
            width: 85%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        .close-icon {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 24px;
            background: none; border: none;
            cursor: pointer; color: #999;
        }

        #question-text { font-size: 22px; color: #333; margin-bottom: 5px; }
        
        #media-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        #q-video {
            width: 100%;
            max-height: 25vh;
            border-radius: 8px;
            display: none;
            background: black;
        }

        #audio-btn {
            background-color: #8e44ad;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: none; 
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto;
            width: fit-content;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #audio-btn:active { transform: scale(0.95); background-color: #732d91; }
        #audio-btn:disabled { background-color: #bdc3c7; cursor: wait; }

        #answer-text { 
            font-size: 20px; 
            color: #27ae60; 
            font-weight: bold; 
            display: none; 
            padding: 10px; 
            background: #e8f8f5; 
            border-radius: 10px; 
        }

        .modal-btn {
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            color: white;
        }

        .btn-reveal { background-color: #34495e; }
        
        .team-select {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            display: none;
        }

        .btn-red { background-color: var(--red); }
        .btn-blue { background-color: var(--blue); }
        .btn-green { background-color: var(--green); }
        .btn-yellow { background-color: var(--yellow); color: #333; }
        
    </style>
</head>
<body>

<!-- START MENU VIEW -->
<div id="start-menu" class="view-section active">
    <h1>Attack 25</h1>
    
    <div style="text-align: center; margin-bottom: 10px;">Select Teams:</div>
    <div class="team-selector">
        <button class="ts-btn" onclick="selectTeams(2)" id="ts-2">2 Teams</button>
        <button class="ts-btn" onclick="selectTeams(3)" id="ts-3">3 Teams</button>
        <button class="ts-btn selected" onclick="selectTeams(4)" id="ts-4">4 Teams</button>
    </div>

    <button class="menu-btn primary" onclick="startGame()">Start Game</button>
    <button class="menu-btn" onclick="openEditor()">Edit Questions</button>
</div>

<!-- EDITOR VIEW -->
<div id="editor-view" class="view-section">
    <div class="editor-header">
        <button class="reset-btn" onclick="showMenu()">‚Üê Back</button>
        <h2>Edit Questions</h2>
        <button class="reset-btn" style="background:#e74c3c" onclick="resetQuestionsToDefault()">Reset Defaults</button>
    </div>
    <div id="editor-list" class="editor-list"></div>
    <div style="padding: 10px; width: 100%; max-width: 800px; display: flex; gap: 10px;">
        <button class="menu-btn primary" style="width:100%" onclick="saveQuestions()">Save Changes</button>
    </div>
</div>

<!-- GAME VIEW -->
<div id="game-view" class="view-section">
    <header>
        <button class="icon-btn" onclick="showMenu()">‚ò∞</button>
        <h1>Attack 25</h1>
        <button class="reset-btn" onclick="confirmReset()">Reset Board</button>
    </header>

    <div id="scoreboard">
        <div class="score-card sc-red" id="card-red"><span>Red</span><strong id="score-red">0</strong></div>
        <div class="score-card sc-blue" id="card-blue"><span>Blue</span><strong id="score-blue">0</strong></div>
        <div class="score-card sc-green" id="card-green"><span>Green</span><strong id="score-green">0</strong></div>
        <div class="score-card sc-yellow" id="card-yellow"><span>Yellow</span><strong id="score-yellow">0</strong></div>
    </div>

    <div id="game-board"></div>
</div>

<!-- Modal -->
<div id="modal-overlay">
    <div class="modal-content">
        <button class="close-icon" onclick="closeModal()">√ó</button>
        <div id="question-number" style="color: #7f8c8d; font-size: 14px;">QUESTION</div>
        
        <div id="question-text">...</div>

        <div id="media-container">
            <video id="q-video" controls playsinline></video>
            <button id="audio-btn" onclick="toggleAudio()">
                <span>üîä</span> <span id="audio-btn-text">Play Audio</span>
            </button>
        </div>
        
        <button id="reveal-btn" class="modal-btn btn-reveal" onclick="revealAnswer()">Show Answer</button>
        
        <div id="answer-text">...</div>

        <div id="team-selector" class="team-select">
            <button class="modal-btn btn-red" id="btn-red" onclick="captureSquare('red')">Red</button>
            <button class="modal-btn btn-blue" id="btn-blue" onclick="captureSquare('blue')">Blue</button>
            <button class="modal-btn btn-green" id="btn-green" onclick="captureSquare('green')">Green</button>
            <button class="modal-btn btn-yellow" id="btn-yellow" onclick="captureSquare('yellow')">Yellow</button>
        </div>
    </div>
</div>

<audio id="external-audio"></audio>

<script>
    // --- Initial Data ---
    const defaultQuestions = [
        { id: 1, q: "What is the capital of the U.K.?", a: "London" },
        { id: 2, q: "What is the money of Australia?", a: "Australian Dollar" },
        { id: 3, q: "What are the 3 most popular sports in the UK?", a: "Football, Rugby, Cricket" },
        { id: 4, q: "What is the capital of France?", a: "Paris" },
        { id: 5, q: "Who sang 'We Will Rock You'?", a: "Queen", audio: "assets/wewillrockyou.mp3" },
        { id: 6, q: "What city is the Opera House in?", a: "Sydney" },
        { id: 7, q: "Which famous British group is this?", a: "The Beatles", video: "assets/pennylane.mp4", reverse: true }, 
        { id: 8, q: "What is the money of America?", a: "Dollar ($)" },
        { id: 9, q: "What is the money of the U.K.?", a: "Pound (¬£)" },
        { id: 10, q: "Unscramble: nhtalepe", a: "Elephant" },
        { id: 11, q: "Unscramble: clash its smart", a: "Last Christmas" }, 
        { id: 12, q: "What is the most popular sport in Australia?", a: "Australian Rules Football" },
        { id: 13, q: "What is the capital of Canada?", a: "Ottawa" },
        { id: 14, q: "What country is the Kiwi bird from?", a: "New Zealand" },
        { id: 15, q: "What country is the Lemur from?", a: "Madagascar" },
        { id: 16, q: "What country are the Pyramids in?", a: "Egypt" },
        { id: 17, q: "What country is Machu Picchu in?", a: "Peru" },
        { id: 18, q: "What city is the Statue of Liberty in?", a: "New York" },
        { id: 19, q: "What is the money of Germany?", a: "The Euro (‚Ç¨)" },
        { id: 20, q: "What is the capital of China?", a: "Beijing" },
        { id: 21, q: "What city is the Merlion from?", a: "Singapore" },
        { id: 22, q: "What are the four countries of the UK?", a: "England, Scotland, Wales, N. Ireland" },
        { id: 23, q: "What country's national anthem is this?", a: "Canada", audio: "assets/canadaanthem.mp3" },
        { id: 24, q: "What day is December 25th?", a: "Christmas Day" },
        { id: 25, q: "What is the capital of Australia?", a: "Canberra" }
    ];

    let questions = [...defaultQuestions];
    let gridState = Array(25).fill(null); 
    let currentActiveIndex = -1;
    let teamCount = 4;
    
    // Audio Context
    let audioCtx = null; 
    let reversedBuffer = null; 
    let reverseSource = null;

    // --- Persistence ---
    function loadData() {
        // Load Grid State
        const savedGrid = localStorage.getItem('attack25_gh_state');
        if (savedGrid) gridState = JSON.parse(savedGrid);

        // Load Questions
        const savedQs = localStorage.getItem('attack25_questions');
        if (savedQs) {
            questions = JSON.parse(savedQs);
        }

        // Load Settings
        const savedTeams = localStorage.getItem('attack25_teamcount');
        if (savedTeams) {
            teamCount = parseInt(savedTeams);
            updateTeamUI(teamCount);
        }
    }

    function saveData() {
        localStorage.setItem('attack25_gh_state', JSON.stringify(gridState));
        localStorage.setItem('attack25_questions', JSON.stringify(questions));
        localStorage.setItem('attack25_teamcount', teamCount);
    }

    // --- View Management ---
    function showView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    function showMenu() {
        showView('start-menu');
    }

    function startGame() {
        renderGrid();
        configureTeamsInGame();
        showView('game-view');
    }

    function selectTeams(count) {
        teamCount = count;
        updateTeamUI(count);
        saveData();
    }

    function updateTeamUI(count) {
        document.querySelectorAll('.ts-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById('ts-' + count).classList.add('selected');
    }

    function configureTeamsInGame() {
        // Scoreboard
        document.getElementById('card-red').style.display = 'flex';
        document.getElementById('card-blue').style.display = 'flex';
        document.getElementById('card-green').style.display = count >= 3 ? 'flex' : 'none';
        document.getElementById('card-yellow').style.display = count >= 4 ? 'flex' : 'none';

        // Modal Buttons
        document.getElementById('btn-red').style.display = 'block';
        document.getElementById('btn-blue').style.display = 'block';
        document.getElementById('btn-green').style.display = count >= 3 ? 'block' : 'none';
        document.getElementById('btn-yellow').style.display = count >= 4 ? 'block' : 'none';
        
        // Grid styling to match team count? Not necessary, modal handles input.
        updateScoreboard();
    }
    
    // Variable capture for team count in configuration
    let count = 4; // internal helper
    const _oldConfig = configureTeamsInGame;
    configureTeamsInGame = function() {
        count = teamCount;
        _oldConfig();
    }


    // --- Editor Logic ---
    function openEditor() {
        const list = document.getElementById('editor-list');
        list.innerHTML = '';
        questions.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = 'edit-item';
            div.innerHTML = `
                <strong>Question ${idx + 1}</strong>
                <div class="edit-row">
                    <label class="edit-label">Q:</label>
                    <input class="edit-input" id="eq-${idx}" value="${q.q.replace(/"/g, '&quot;')}" placeholder="Question text">
                </div>
                <div class="edit-row">
                    <label class="edit-label">A:</label>
                    <input class="edit-input" id="ea-${idx}" value="${q.a.replace(/"/g, '&quot;')}" placeholder="Answer text">
                </div>
                <div class="edit-row">
                    <label class="edit-label">Audio:</label>
                    <input class="edit-input" id="eau-${idx}" value="${q.audio || ''}" placeholder="assets/filename.mp3">
                </div>
                <div class="edit-row">
                    <label class="edit-label">Video:</label>
                    <input class="edit-input" id="ev-${idx}" value="${q.video || ''}" placeholder="assets/filename.mp4">
                </div>
                <div class="edit-row">
                    <label class="edit-label" style="width:auto; margin-right:10px;">Reverse Video Audio?</label>
                    <input type="checkbox" id="er-${idx}" ${q.reverse ? 'checked' : ''}>
                </div>
            `;
            list.appendChild(div);
        });
        showView('editor-view');
    }

    function saveQuestions() {
        questions.forEach((_, idx) => {
            questions[idx].q = document.getElementById(`eq-${idx}`).value;
            questions[idx].a = document.getElementById(`ea-${idx}`).value;
            const audio = document.getElementById(`eau-${idx}`).value;
            const video = document.getElementById(`ev-${idx}`).value;
            const reverse = document.getElementById(`er-${idx}`).checked;

            if(audio) questions[idx].audio = audio; else delete questions[idx].audio;
            if(video) questions[idx].video = video; else delete questions[idx].video;
            if(reverse) questions[idx].reverse = true; else delete questions[idx].reverse;
        });
        saveData();
        alert("Questions Saved!");
        showMenu();
    }

    function resetQuestionsToDefault() {
        if(confirm("Are you sure? This will erase all custom edits.")) {
            questions = JSON.parse(JSON.stringify(defaultQuestions));
            saveData();
            openEditor();
        }
    }


    // --- Audio System ---
    function initAudio() {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    async function loadAndReverse(url) {
        initAudio();
        const btn = document.getElementById('audio-btn');
        const btnText = document.getElementById('audio-btn-text');
        
        btn.disabled = true;
        btnText.textContent = "Loading...";

        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            
            const reversed = audioCtx.createBuffer(
                audioBuffer.numberOfChannels,
                audioBuffer.length,
                audioBuffer.sampleRate
            );

            for (let i = 0; i < audioBuffer.numberOfChannels; i++) {
                const channelData = audioBuffer.getChannelData(i);
                const reversedData = reversed.getChannelData(i);
                for (let j = 0; j < channelData.length; j++) {
                    reversedData[j] = channelData[channelData.length - 1 - j];
                }
            }

            reversedBuffer = reversed;
            btnText.textContent = "Play Backwards";
            btn.disabled = false;
        } catch (e) {
            console.error(e);
            btnText.textContent = "Error Loading";
        }
    }

    function playReversed() {
        if (reverseSource) {
            try { reverseSource.stop(); } catch(e) {}
            reverseSource = null;
            document.getElementById('audio-btn-text').textContent = "Play Backwards";
            return;
        }
        if (!reversedBuffer) return;

        reverseSource = audioCtx.createBufferSource();
        reverseSource.buffer = reversedBuffer;
        reverseSource.connect(audioCtx.destination);
        reverseSource.start();
        document.getElementById('audio-btn-text').textContent = "Stop";
        reverseSource.onended = () => {
            reverseSource = null;
            document.getElementById('audio-btn-text').textContent = "Play Backwards";
        };
    }

    function playTone(freq, type, duration, startTime = 0) {
        if (!audioCtx) initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime + startTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + startTime);
        osc.stop(audioCtx.currentTime + startTime + duration);
    }

    const sfx = {
        click: () => playTone(600, 'sine', 0.1),
        reveal: () => {
            playTone(400, 'triangle', 0.1, 0);
            playTone(500, 'triangle', 0.1, 0.1);
            playTone(600, 'triangle', 0.3, 0.2);
        },
        steal: () => {
            playTone(150, 'sawtooth', 0.2, 0);
            playTone(100, 'sawtooth', 0.4, 0.2);
        }
    };


    // --- Game Logic ---
    function renderGrid() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        
        gridState.forEach((color, index) => {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.textContent = index + 1;
            
            if (color) {
                tile.classList.add('taken');
                tile.setAttribute('data-color', color);
            }
            tile.onclick = () => handleTileClick(index);
            board.appendChild(tile);
        });
        updateScoreboard();
    }

    function updateScoreboard() {
        const scores = { red: 0, blue: 0, green: 0, yellow: 0 };
        gridState.forEach(color => {
            if (color && scores.hasOwnProperty(color)) scores[color] += 3; 
        });
        document.getElementById('score-red').textContent = scores.red;
        document.getElementById('score-blue').textContent = scores.blue;
        document.getElementById('score-green').textContent = scores.green;
        document.getElementById('score-yellow').textContent = scores.yellow;
    }

    function handleTileClick(index) {
        initAudio(); 
        sfx.click();
        
        currentActiveIndex = index;
        const qData = questions[index];
        
        document.getElementById('question-number').textContent = "QUESTION " + (index + 1);
        document.getElementById('question-text').textContent = qData.q;
        document.getElementById('answer-text').textContent = qData.a;
        
        // Reset Media
        const audioBtn = document.getElementById('audio-btn');
        const videoEl = document.getElementById('q-video');
        const externalPlayer = document.getElementById('external-audio');
        stopAllAudio();

        // Video
        if (qData.video) {
            videoEl.src = qData.video;
            videoEl.style.display = 'none'; 
            if (qData.reverse) {
                audioBtn.style.display = 'flex';
                loadAndReverse(qData.video); 
            } else {
                audioBtn.style.display = 'none';
            }
        } else {
            videoEl.style.display = 'none';
            videoEl.removeAttribute('src');
            audioBtn.style.display = 'none';
        }

        // Audio
        if (qData.audio) {
            audioBtn.style.display = 'flex';
            externalPlayer.src = qData.audio;
            document.getElementById('audio-btn-text').textContent = "Play Audio";
        }

        document.getElementById('reveal-btn').style.display = 'block';
        document.getElementById('answer-text').style.display = 'none';
        document.getElementById('team-selector').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function toggleAudio() {
        const qData = questions[currentActiveIndex];
        if (qData.video && qData.reverse) {
            playReversed();
            return;
        }
        const player = document.getElementById('external-audio');
        const btnText = document.getElementById('audio-btn-text');
        
        if (player.paused) {
            player.play()
                .then(() => btnText.textContent = "Pause Audio")
                .catch(e => alert("Audio file not found in assets folder!"));
        } else {
            player.pause();
            btnText.textContent = "Play Audio";
        }
    }

    function stopAllAudio() {
        document.getElementById('external-audio').pause();
        document.getElementById('external-audio').currentTime = 0;
        document.getElementById('q-video').pause();
        if (reverseSource) {
            try { reverseSource.stop(); } catch(e) {}
            reverseSource = null;
        }
    }

    function revealAnswer() {
        sfx.reveal();
        stopAllAudio(); 
        
        document.getElementById('reveal-btn').style.display = 'none';
        document.getElementById('answer-text').style.display = 'block';
        document.getElementById('team-selector').style.display = 'grid';

        const qData = questions[currentActiveIndex];
        if (qData.video) {
            const videoEl = document.getElementById('q-video');
            videoEl.style.display = 'block';
            videoEl.play();
        }
    }

    function captureSquare(color) {
        if (currentActiveIndex === -1) return;

        let isSteal = false;
        if (gridState[currentActiveIndex] !== null && gridState[currentActiveIndex] !== color) {
            isSteal = true;
        }

        gridState[currentActiveIndex] = color;
        const trapped = applyTrapLogic(currentActiveIndex, color);
        
        if (isSteal || trapped) sfx.steal();
        else sfx.click();

        saveData();
        renderGrid();
        closeModal();
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        stopAllAudio();
        currentActiveIndex = -1;
    }

    function applyTrapLogic(index, color) {
        let didTrap = false;
        const row = Math.floor(index / 5);
        const col = index % 5;
        const directions = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];

        directions.forEach(dir => {
            const tilesToFlip = [];
            let r = row + dir[0];
            let c = col + dir[1];

            while (r >= 0 && r < 5 && c >= 0 && c < 5) {
                const checkIndex = r * 5 + c;
                const checkColor = gridState[checkIndex];
                if (!checkColor) break; 
                if (checkColor === color) {
                    if (tilesToFlip.length > 0) didTrap = true;
                    tilesToFlip.forEach(idx => gridState[idx] = color);
                    break;
                } else {
                    tilesToFlip.push(checkIndex);
                }
                r += dir[0]; c += dir[1];
            }
        });
        return didTrap;
    }

    function confirmReset() {
        const btn = document.querySelector('.reset-btn');
        if (btn.textContent === 'Confirm?') {
            gridState = Array(25).fill(null);
            saveData();
            renderGrid();
            btn.textContent = 'Reset Board';
        } else {
            btn.textContent = 'Confirm?';
            setTimeout(() => btn.textContent = 'Reset Board', 3000);
        }
    }

    // Initialize
    window.addEventListener('load', loadData);

</script>
</body>
</html>
