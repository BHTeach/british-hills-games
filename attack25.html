<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attack 25 v2</title>
    <style>
        :root {
            /* Visual Theme: Modern Gradient */
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            
            --grid-gap: 1.2vmin;
            --tile-base: #ffffff;
            --text-color: #2c3e50;
            
            /* Team Colors (Vibrant) */
            --red: #ff4757;
            --blue: #1e90ff;
            --green: #2ed573;
            --yellow: #ffa502;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 10px;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
        }

        /* Views System */
        .view-section {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        .view-section.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Start Menu (Glassmorphism) --- */
        #start-menu {
            justify-content: center;
            gap: 25px;
            height: 100vh;
        }
        
        .logo-placeholder {
            font-size: 8vmin;
            font-weight: 800;
            background: linear-gradient(45deg, var(--blue), var(--red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-shadow: 0px 4px 10px rgba(0,0,0,0.1);
        }

        .menu-card {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            padding: 30px;
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            border: var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 450px;
            align-items: center;
        }

        .menu-btn {
            background: white;
            border: 1px solid #e1e1e1;
            padding: 18px 0;
            font-size: 20px;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .menu-btn:active { transform: scale(0.98); }
        .menu-btn.primary { 
            background: linear-gradient(135deg, var(--blue), #0984e3); 
            color: white; 
            border: none;
            box-shadow: 0 4px 15px rgba(30, 144, 255, 0.3);
        }
        
        .team-selector {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        .ts-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: bold;
            color: #777;
        }
        .ts-btn.selected { 
            background: var(--blue); 
            color: white; 
            border-color: var(--blue);
            box-shadow: 0 2px 8px rgba(30, 144, 255, 0.3);
        }

        /* --- Editor --- */
        #editor-view { padding: 20px; height: 100vh; overflow: hidden; }
        .editor-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
            align-items: center;
        }
        .editor-list {
            flex: 1;
            overflow-y: auto;
            width: 100%;
            max-width: 800px;
            padding-bottom: 50px;
        }
        .edit-item {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        .edit-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .edit-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #eee;
            background: #fcfcfc;
            border-radius: 8px;
            font-size: 16px;
        }
        .edit-input:focus { outline: none; border-color: var(--blue); background: white; }
        .edit-label { font-size: 13px; font-weight: 600; color: #999; width: 60px; }

        /* --- Game Header --- */
        header {
            width: 95vmin;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            margin-bottom: 10px;
        }
        .icon-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-color); }
        .reset-btn {
            background: rgba(0,0,0,0.1);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .reset-btn:hover { background: rgba(0,0,0,0.2); }

        /* --- Scoreboard --- */
        #scoreboard {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            width: 95vmin;
            height: 70px;
            margin-bottom: 15px;
        }
        .score-card {
            flex: 1;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .score-card::after {
            content: ''; position: absolute; top:0; left:0; right:0; height: 30%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent);
        }
        .score-card span { font-size: 12px; font-weight: 600; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
        .score-card strong { font-size: 28px; line-height: 1; margin-bottom: 4px; }

        .sc-red { background: var(--red); }
        .sc-blue { background: var(--blue); }
        .sc-green { background: var(--green); }
        .sc-yellow { background: var(--yellow); color: #333; }

        /* --- Grid (3D Effect) --- */
        #game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: var(--grid-gap);
            width: 90vmin;
            height: 90vmin;
            margin: 0 auto;
            background: rgba(255,255,255,0.5);
            padding: var(--grid-gap);
            border-radius: 24px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }

        .tile {
            background-color: var(--tile-base);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4vmin;
            font-weight: 800;
            color: #dcdcdc;
            cursor: pointer;
            box-shadow: 0 4px 0 #e0e0e0;
            width: 100%;
            height: 100%;
            transition: transform 0.1s, background-color 0.3s, color 0.3s;
            position: relative;
        }

        .tile:active { transform: translateY(4px); box-shadow: 0 0 0 transparent; }
        
        .tile.taken { 
            color: white; 
            text-shadow: 0 2px 0 rgba(0,0,0,0.2); 
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        
        .tile[data-color="red"] { background-color: var(--red); box-shadow: 0 4px 0 #c41e30; }
        .tile[data-color="blue"] { background-color: var(--blue); box-shadow: 0 4px 0 #0c71c3; }
        .tile[data-color="green"] { background-color: var(--green); box-shadow: 0 4px 0 #218c53; }
        .tile[data-color="yellow"] { background-color: var(--yellow); color: #333; text-shadow: none; box-shadow: 0 4px 0 #e1b12c; }

        /* --- Modal (Modern) --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 30px;
            width: 85%;
            max-width: 550px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .close-icon {
            position: absolute; top: 15px; right: 20px;
            font-size: 28px; background: none; border: none;
            cursor: pointer; color: #bbb;
        }
        .close-icon:hover { color: #333; }

        #question-number {
            color: var(--blue);
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        #question-text { 
            font-size: 24px; 
            color: #333; 
            font-weight: 600;
            line-height: 1.3;
        }
        
        #media-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        /* Image Styling */
        #q-image {
            max-width: 100%;
            max-height: 30vh;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            object-fit: contain;
        }

        #q-video {
            width: 100%;
            max-height: 25vh;
            border-radius: 12px;
            display: none;
            background: black;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #audio-btn {
            background-color: var(--blue);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: none; 
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(30, 144, 255, 0.3);
            transition: transform 0.1s;
        }
        #audio-btn:active { transform: scale(0.95); }

        #answer-text { 
            font-size: 22px; 
            color: var(--green); 
            font-weight: 800; 
            display: none; 
            padding: 20px; 
            background: #f0fdf4; 
            border: 2px solid #dcfce7;
            border-radius: 16px; 
        }

        .modal-btn {
            padding: 16px;
            font-size: 18px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            width: 100%;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .modal-btn:active { transform: translateY(2px); box-shadow: none; }

        .btn-reveal { background-color: #34495e; box-shadow: 0 4px 0 #2c3e50; }
        
        .team-select {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            display: none;
        }

        .btn-red { background: var(--red); box-shadow: 0 4px 0 #c41e30; }
        .btn-blue { background: var(--blue); box-shadow: 0 4px 0 #0c71c3; }
        .btn-green { background: var(--green); box-shadow: 0 4px 0 #218c53; }
        .btn-yellow { background: var(--yellow); color: #333; box-shadow: 0 4px 0 #e1b12c; }
        
    </style>
</head>
<body>

<!-- START MENU VIEW -->
<div id="start-menu" class="view-section active">
    <div class="logo-placeholder">ATTACK 25</div>
    
    <div class="menu-card">
        <div style="width: 100%;">
            <div style="margin-bottom: 8px; font-weight: 600; color: #666; font-size: 14px;">NUMBER OF TEAMS</div>
            <div class="team-selector">
                <button class="ts-btn" onclick="selectTeams(2)" id="ts-2">2</button>
                <button class="ts-btn" onclick="selectTeams(3)" id="ts-3">3</button>
                <button class="ts-btn selected" onclick="selectTeams(4)" id="ts-4">4</button>
            </div>
        </div>
        
        <button class="menu-btn primary" onclick="startGame()">Start Game</button>
        <button class="menu-btn" onclick="openEditor()">Edit Questions</button>
    </div>
</div>

<!-- EDITOR VIEW -->
<div id="editor-view" class="view-section">
    <div class="editor-header">
        <button class="reset-btn" onclick="showMenu()">‚Üê Back</button>
        <h2 style="margin:0; font-size: 18px;">Question Editor</h2>
        <button class="reset-btn" style="color:var(--red); background:rgba(231, 76, 60, 0.1);" onclick="resetQuestionsToDefault()">Reset Defaults</button>
    </div>
    <div id="editor-list" class="editor-list"></div>
    <div style="padding: 10px; width: 100%; max-width: 800px;">
        <button class="menu-btn primary" onclick="saveQuestions()">Save Changes</button>
    </div>
</div>

<!-- GAME VIEW -->
<div id="game-view" class="view-section">
    <header>
        <button class="icon-btn" onclick="showMenu()">‚ò∞</button>
        <h1 style="font-size: 20px; font-weight: 800; letter-spacing: 1px;">ATTACK 25</h1>
        <button class="reset-btn" onclick="confirmReset()">Reset Board</button>
    </header>

    <div id="scoreboard">
        <div class="score-card sc-red" id="card-red"><span>Red</span><strong id="score-red">0</strong></div>
        <div class="score-card sc-blue" id="card-blue"><span>Blue</span><strong id="score-blue">0</strong></div>
        <div class="score-card sc-green" id="card-green"><span>Green</span><strong id="score-green">0</strong></div>
        <div class="score-card sc-yellow" id="card-yellow"><span>Yellow</span><strong id="score-yellow">0</strong></div>
    </div>

    <div id="game-board"></div>
</div>

<!-- Modal -->
<div id="modal-overlay">
    <div class="modal-content">
        <button class="close-icon" onclick="closeModal()">√ó</button>
        <div id="question-number">QUESTION</div>
        
        <div id="media-container">
            <!-- New Image Element -->
            <img id="q-image" src="" alt="Question Image">
            <video id="q-video" controls playsinline></video>
            <button id="audio-btn" onclick="toggleAudio()">
                <span>üîä</span> <span id="audio-btn-text">Play Audio</span>
            </button>
        </div>

        <div id="question-text">...</div>
        
        <button id="reveal-btn" class="modal-btn btn-reveal" onclick="revealAnswer()">Show Answer</button>
        
        <div id="answer-text">...</div>

        <div id="team-selector" class="team-select">
            <button class="modal-btn btn-red" id="btn-red" onclick="captureSquare('red')">Red</button>
            <button class="modal-btn btn-blue" id="btn-blue" onclick="captureSquare('blue')">Blue</button>
            <button class="modal-btn btn-green" id="btn-green" onclick="captureSquare('green')">Green</button>
            <button class="modal-btn btn-yellow" id="btn-yellow" onclick="captureSquare('yellow')">Yellow</button>
        </div>
    </div>
</div>

<audio id="external-audio"></audio>

<script>
    // --- Initial Data with FIXED LIVE IMAGES ---
    const defaultQuestions = [
        { id: 1, q: "What is the capital of the U.K.?", a: "London" },
        // Fixed: Stable file link for Aus 5 Dollar note
        { id: 2, q: "What is the money of Australia?", a: "Australian Dollar", image: "https://upload.wikimedia.org/wikipedia/commons/8/87/Australian_5_dollar_note_2016_design.jpg" },
        { id: 3, q: "What are the 3 most popular sports in the UK?", a: "Football, Rugby, Cricket" },
        { id: 4, q: "What is the capital of France?", a: "Paris" },
        { id: 5, q: "Who sang 'We Will Rock You'?", a: "Queen", audio: "assets/wewillrockyou.mp3" },
        { id: 6, q: "What city is the Opera House in?", a: "Sydney", image: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/40/Sydney_Opera_House_Sails.jpg/640px-Sydney_Opera_House_Sails.jpg" },
        { id: 7, q: "Which famous British group is this?", a: "The Beatles", video: "assets/pennylane.mp4", reverse: true }, 
        { id: 8, q: "What is the money of America?", a: "Dollar ($)" },
        { id: 9, q: "What is the money of the U.K.?", a: "Pound (¬£)" },
        { id: 10, q: "Unscramble: nhtalepe", a: "Elephant", image: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Elephant_Diversity.jpg/640px-Elephant_Diversity.jpg" },
        { id: 11, q: "Unscramble: clash its smart", a: "Last Christmas" }, 
        { id: 12, q: "What is the most popular sport in Australia?", a: "Australian Rules Football" },
        { id: 13, q: "What is the capital of Canada?", a: "Ottawa" },
        // Fixed: Stable Kiwi run image
        { id: 14, q: "What country is this animal from?", a: "New Zealand", image: "https://upload.wikimedia.org/wikipedia/commons/b/b8/Kiwi_run.jpg" },
        // Fixed: Stable Lemur image
        { id: 15, q: "What country is this animal from?", a: "Madagascar", image: "https://upload.wikimedia.org/wikipedia/commons/2/20/Ring-tailed_lemur_%28Lemur_catta%29.jpg" },
        { id: 16, q: "What country are the Pyramids in?", a: "Egypt", image: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e3/Kheops-Pyramid.jpg/640px-Kheops-Pyramid.jpg" },
        { id: 17, q: "What country is Machu Picchu in?", a: "Peru", image: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Machu_Picchu%2C_Peru.jpg/640px-Machu_Picchu%2C_Peru.jpg" },
        { id: 18, q: "What city is the Statue of Liberty in?", a: "New York", image: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a1/Statue_of_Liberty_7.jpg/640px-Statue_of_Liberty_7.jpg" },
        { id: 19, q: "What is the money of Germany?", a: "The Euro (‚Ç¨)" },
        { id: 20, q: "What is the capital of China?", a: "Beijing" },
        // Fixed: Stable Merlion image
        { id: 21, q: "What city is the Merlion from?", a: "Singapore", image: "https://upload.wikimedia.org/wikipedia/commons/a/a6/Merlion_Singapore_Water_Feature.jpg" },
        { id: 22, q: "What are the four countries of the UK?", a: "England, Scotland, Wales, N. Ireland" },
        { id: 23, q: "What country's national anthem is this?", a: "Canada", audio: "assets/canadaanthem.mp3" },
        { id: 24, q: "What day is December 25th?", a: "Christmas Day" },
        { id: 25, q: "What is the capital of Australia?", a: "Canberra" }
    ];

    let questions = [...defaultQuestions];
    let gridState = Array(25).fill(null); 
    let currentActiveIndex = -1;
    let teamCount = 4;
    
    // Audio Context
    let audioCtx = null; 
    let reversedBuffer = null; 
    let reverseSource = null;

    // --- Persistence ---
    function loadData() {
        const savedGrid = localStorage.getItem('attack25_v2_state');
        if (savedGrid) gridState = JSON.parse(savedGrid);

        const savedQs = localStorage.getItem('attack25_v2_questions');
        if (savedQs) questions = JSON.parse(savedQs);

        const savedTeams = localStorage.getItem('attack25_v2_teamcount');
        if (savedTeams) {
            teamCount = parseInt(savedTeams);
            updateTeamUI(teamCount);
        }
    }

    function saveData() {
        localStorage.setItem('attack25_v2_state', JSON.stringify(gridState));
        localStorage.setItem('attack25_v2_questions', JSON.stringify(questions));
        localStorage.setItem('attack25_v2_teamcount', teamCount);
    }

    // --- View Management ---
    function showView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    function showMenu() { showView('start-menu'); }

    function startGame() {
        renderGrid();
        configureTeamsInGame();
        showView('game-view');
    }

    function selectTeams(count) {
        teamCount = count;
        updateTeamUI(count);
        saveData();
    }

    function updateTeamUI(count) {
        document.querySelectorAll('.ts-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById('ts-' + count).classList.add('selected');
    }

    function configureTeamsInGame() {
        // Scoreboard
        document.getElementById('card-red').style.display = 'flex';
        document.getElementById('card-blue').style.display = 'flex';
        document.getElementById('card-green').style.display = count >= 3 ? 'flex' : 'none';
        document.getElementById('card-yellow').style.display = count >= 4 ? 'flex' : 'none';

        // Modal Buttons
        document.getElementById('btn-red').style.display = 'block';
        document.getElementById('btn-blue').style.display = 'block';
        document.getElementById('btn-green').style.display = count >= 3 ? 'block' : 'none';
        document.getElementById('btn-yellow').style.display = count >= 4 ? 'block' : 'none';
        
        updateScoreboard();
    }
    
    let count = 4;
    const _oldConfig = configureTeamsInGame;
    configureTeamsInGame = function() {
        count = teamCount;
        _oldConfig();
    }

    // --- Editor Logic ---
    function openEditor() {
        const list = document.getElementById('editor-list');
        list.innerHTML = '';
        questions.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = 'edit-item';
            div.innerHTML = `
                <strong>Question ${idx + 1}</strong>
                <div class="edit-row">
                    <label class="edit-label">Q:</label>
                    <input class="edit-input" id="eq-${idx}" value="${q.q.replace(/"/g, '&quot;')}" placeholder="Question text">
                </div>
                <div class="edit-row">
                    <label class="edit-label">A:</label>
                    <input class="edit-input" id="ea-${idx}" value="${q.a.replace(/"/g, '&quot;')}" placeholder="Answer text">
                </div>
                <div class="edit-row">
                    <label class="edit-label">Image:</label>
                    <input class="edit-input" id="eimg-${idx}" value="${q.image || ''}" placeholder="assets/image.jpg">
                </div>
                <div class="edit-row">
                    <label class="edit-label">Audio:</label>
                    <input class="edit-input" id="eau-${idx}" value="${q.audio || ''}" placeholder="assets/sound.mp3">
                </div>
                <div class="edit-row">
                    <label class="edit-label">Video:</label>
                    <input class="edit-input" id="ev-${idx}" value="${q.video || ''}" placeholder="assets/video.mp4">
                </div>
                <div class="edit-row">
                    <label class="edit-label" style="width:auto; margin-right:10px;">Reverse Video Audio?</label>
                    <input type="checkbox" id="er-${idx}" ${q.reverse ? 'checked' : ''}>
                </div>
            `;
            list.appendChild(div);
        });
        showView('editor-view');
    }

    function saveQuestions() {
        questions.forEach((_, idx) => {
            questions[idx].q = document.getElementById(`eq-${idx}`).value;
            questions[idx].a = document.getElementById(`ea-${idx}`).value;
            const img = document.getElementById(`eimg-${idx}`).value;
            const audio = document.getElementById(`eau-${idx}`).value;
            const video = document.getElementById(`ev-${idx}`).value;
            const reverse = document.getElementById(`er-${idx}`).checked;

            if(img) questions[idx].image = img; else delete questions[idx].image;
            if(audio) questions[idx].audio = audio; else delete questions[idx].audio;
            if(video) questions[idx].video = video; else delete questions[idx].video;
            if(reverse) questions[idx].reverse = true; else delete questions[idx].reverse;
        });
        saveData();
        alert("Questions Saved!");
        showMenu();
    }

    function resetQuestionsToDefault() {
        if(confirm("Are you sure? This will erase all custom edits.")) {
            questions = JSON.parse(JSON.stringify(defaultQuestions));
            saveData();
            openEditor();
        }
    }

    // --- Audio/Video System ---
    function initAudio() {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }
        if (audioCtx.state === 'suspended') { audioCtx.resume(); }
    }

    async function loadAndReverse(url) {
        initAudio();
        const btn = document.getElementById('audio-btn');
        const btnText = document.getElementById('audio-btn-text');
        
        btn.disabled = true;
        btnText.textContent = "Loading...";

        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            
            const reversed = audioCtx.createBuffer(
                audioBuffer.numberOfChannels,
                audioBuffer.length,
                audioBuffer.sampleRate
            );

            for (let i = 0; i < audioBuffer.numberOfChannels; i++) {
                const channelData = audioBuffer.getChannelData(i);
                const reversedData = reversed.getChannelData(i);
                for (let j = 0; j < channelData.length; j++) {
                    reversedData[j] = channelData[channelData.length - 1 - j];
                }
            }

            reversedBuffer = reversed;
            btnText.textContent = "Play Backwards";
            btn.disabled = false;
        } catch (e) {
            console.error(e);
            btnText.textContent = "Error Loading";
        }
    }

    function playReversed() {
        if (reverseSource) {
            try { reverseSource.stop(); } catch(e) {}
            reverseSource = null;
            document.getElementById('audio-btn-text').textContent = "Play Backwards";
            return;
        }
        if (!reversedBuffer) return;

        reverseSource = audioCtx.createBufferSource();
        reverseSource.buffer = reversedBuffer;
        reverseSource.connect(audioCtx.destination);
        reverseSource.start();
        document.getElementById('audio-btn-text').textContent = "Stop";
        reverseSource.onended = () => {
            reverseSource = null;
            document.getElementById('audio-btn-text').textContent = "Play Backwards";
        };
    }

    function playTone(freq, type, duration, startTime = 0) {
        if (!audioCtx) initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime + startTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + startTime);
        osc.stop(audioCtx.currentTime + startTime + duration);
    }

    const sfx = {
        click: () => playTone(600, 'sine', 0.1),
        reveal: () => {
            playTone(400, 'triangle', 0.1, 0);
            playTone(500, 'triangle', 0.1, 0.1);
            playTone(600, 'triangle', 0.3, 0.2);
        },
        steal: () => {
            playTone(150, 'sawtooth', 0.2, 0);
            playTone(100, 'sawtooth', 0.4, 0.2);
        }
    };

    // --- Game Logic ---
    function renderGrid() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        
        gridState.forEach((color, index) => {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.textContent = index + 1;
            
            if (color) {
                tile.classList.add('taken');
                tile.setAttribute('data-color', color);
            }
            tile.onclick = () => handleTileClick(index);
            board.appendChild(tile);
        });
        updateScoreboard();
    }

    function updateScoreboard() {
        const scores = { red: 0, blue: 0, green: 0, yellow: 0 };
        gridState.forEach(color => {
            if (color && scores.hasOwnProperty(color)) scores[color] += 3; 
        });
        document.getElementById('score-red').textContent = scores.red;
        document.getElementById('score-blue').textContent = scores.blue;
        document.getElementById('score-green').textContent = scores.green;
        document.getElementById('score-yellow').textContent = scores.yellow;
    }

    function handleTileClick(index) {
        initAudio(); 
        sfx.click();
        
        currentActiveIndex = index;
        const qData = questions[index];
        
        document.getElementById('question-number').textContent = "QUESTION " + (index + 1);
        document.getElementById('question-text').textContent = qData.q;
        document.getElementById('answer-text').textContent = qData.a;
        
        // Reset Media
        const audioBtn = document.getElementById('audio-btn');
        const videoEl = document.getElementById('q-video');
        const imageEl = document.getElementById('q-image');
        const externalPlayer = document.getElementById('external-audio');
        stopAllAudio();

        // 1. Image
        if (qData.image) {
            imageEl.src = qData.image;
            imageEl.style.display = 'block';
        } else {
            imageEl.style.display = 'none';
        }

        // 2. Video
        if (qData.video) {
            videoEl.src = qData.video;
            videoEl.style.display = 'none'; 
            if (qData.reverse) {
                audioBtn.style.display = 'flex';
                loadAndReverse(qData.video); 
            } else {
                audioBtn.style.display = 'none';
            }
        } else {
            videoEl.style.display = 'none';
            videoEl.removeAttribute('src');
            audioBtn.style.display = 'none';
        }

        // 3. Audio
        if (qData.audio) {
            audioBtn.style.display = 'flex';
            externalPlayer.src = qData.audio;
            document.getElementById('audio-btn-text').textContent = "Play Audio";
        } else if (!qData.video) {
             // Only hide if not used by video reverse logic
            audioBtn.style.display = 'none';
        }

        document.getElementById('reveal-btn').style.display = 'block';
        document.getElementById('answer-text').style.display = 'none';
        document.getElementById('team-selector').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function toggleAudio() {
        const qData = questions[currentActiveIndex];
        if (qData.video && qData.reverse) {
            playReversed();
            return;
        }
        const player = document.getElementById('external-audio');
        const btnText = document.getElementById('audio-btn-text');
        
        if (player.paused) {
            player.play()
                .then(() => btnText.textContent = "Pause Audio")
                .catch(e => alert("Audio file not found in assets folder!"));
        } else {
            player.pause();
            btnText.textContent = "Play Audio";
        }
    }

    function stopAllAudio() {
        document.getElementById('external-audio').pause();
        document.getElementById('external-audio').currentTime = 0;
        document.getElementById('q-video').pause();
        if (reverseSource) {
            try { reverseSource.stop(); } catch(e) {}
            reverseSource = null;
        }
    }

    function revealAnswer() {
        sfx.reveal();
        stopAllAudio(); 
        
        document.getElementById('reveal-btn').style.display = 'none';
        document.getElementById('answer-text').style.display = 'block';
        document.getElementById('team-selector').style.display = 'grid';

        const qData = questions[currentActiveIndex];
        if (qData.video) {
            const videoEl = document.getElementById('q-video');
            videoEl.style.display = 'block';
            videoEl.play();
        }
    }

    function captureSquare(color) {
        if (currentActiveIndex === -1) return;

        let isSteal = false;
        if (gridState[currentActiveIndex] !== null && gridState[currentActiveIndex] !== color) {
            isSteal = true;
        }

        gridState[currentActiveIndex] = color;
        const trapped = applyTrapLogic(currentActiveIndex, color);
        
        if (isSteal || trapped) sfx.steal();
        else sfx.click();

        saveData();
        renderGrid();
        closeModal();
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        stopAllAudio();
        currentActiveIndex = -1;
    }

    function applyTrapLogic(index, color) {
        let didTrap = false;
        const row = Math.floor(index / 5);
        const col = index % 5;
        const directions = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];

        directions.forEach(dir => {
            const tilesToFlip = [];
            let r = row + dir[0];
            let c = col + dir[1];

            while (r >= 0 && r < 5 && c >= 0 && c < 5) {
                const checkIndex = r * 5 + c;
                const checkColor = gridState[checkIndex];
                if (!checkColor) break; 
                if (checkColor === color) {
                    if (tilesToFlip.length > 0) didTrap = true;
                    tilesToFlip.forEach(idx => gridState[idx] = color);
                    break;
                } else {
                    tilesToFlip.push(checkIndex);
                }
                r += dir[0]; c += dir[1];
            }
        });
        return didTrap;
    }

    function confirmReset() {
        const btn = document.querySelector('.reset-btn');
        if (btn.textContent === 'Confirm?') {
            gridState = Array(25).fill(null);
            saveData();
            renderGrid();
            btn.textContent = 'Reset Board';
        } else {
            btn.textContent = 'Confirm?';
            setTimeout(() => btn.textContent = 'Reset Board', 3000);
        }
    }

    // Initialize
    window.addEventListener('load', loadData);

</script>
</body>
</html>
