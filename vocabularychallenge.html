<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab Pop! - EFL Voice Game</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* iOS Safari prevents bounce scrolling which ruins game feel */
        body {
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Explosion Animation */
        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .exploding {
            animation: explode 0.4s ease-out forwards;
            pointer-events: none; /* Prevent clicking while exploding */
        }

        /* Grid Item Styling */
        .vocab-card {
            transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Pulse animation for the mic icon when active */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .mic-active::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid white;
            top: 0;
            left: 0;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen overflow-hidden flex flex-col font-sans">

    <!-- TOP BAR: Timer & Status -->
    <div class="h-16 bg-white shadow-md flex items-center justify-between px-6 z-10">
        <div class="text-xl font-bold text-gray-700">
            Vocab Pop! <span class="text-xs font-normal text-gray-400 block">Colors Level</span>
        </div>
        
        <!-- Timer Display -->
        <div class="flex items-center gap-2">
            <i class="fa-regular fa-clock text-gray-500"></i>
            <span id="timerDisplay" class="text-3xl font-bold text-blue-600 font-mono">45</span>
        </div>
    </div>

    <!-- GAME AREA: Grid -->
    <div id="gameContainer" class="flex-1 p-4 relative flex items-center justify-center">
        <!-- The Grid -->
        <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full max-w-5xl h-full max-h-full content-center">
            <!-- Items injected by JS -->
        </div>

        <!-- OVERLAYS -->
        
        <!-- Start Screen -->
        <div id="startScreen" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-50 backdrop-blur-sm">
            <h1 class="text-5xl font-extrabold text-white mb-4 tracking-wider">VOCAB POP</h1>
            <p class="text-gray-300 mb-8 text-lg text-center max-w-md">Shout the colors to pop them before time runs out!</p>
            <button onclick="startGame()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center gap-3">
                <i class="fa-solid fa-microphone"></i> Start Game
            </button>
            <p id="httpsWarning" class="hidden text-red-400 mt-4 text-sm font-bold bg-red-900/50 p-2 rounded">
                ⚠️ Warning: Microphone requires HTTPS or Localhost.
            </p>
        </div>

        <!-- Game Over Screen (Win/Lose) -->
        <div id="endScreen" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50">
            <h2 id="endTitle" class="text-6xl font-bold text-white mb-4">GAME OVER</h2>
            <p id="endMessage" class="text-2xl text-gray-300 mb-8">Time's up!</p>
            <button onclick="resetGame()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-10 rounded-xl text-xl shadow-lg">
                Play Again
            </button>
        </div>
    </div>

    <!-- BOTTOM BAR: Speech Debugger -->
    <div class="h-12 bg-gray-800 flex items-center px-4 justify-between">
        <div class="flex items-center gap-3 text-white">
            <div id="micIcon" class="relative w-3 h-3 bg-red-500 rounded-full transition-colors"></div>
            <span class="text-xs text-gray-400 uppercase tracking-widest">Mic Status</span>
        </div>
        <div class="flex-1 text-center">
            <span class="text-gray-500 text-sm mr-2">Heard:</span>
            <span id="transcript" class="text-white font-mono font-bold text-lg italic">...</span>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const GAME_DURATION = 45; // Seconds
        
        // Asset Library
        // To use images later, change 'type' to 'image' and 'val' to the URL.
        const ASSETS = [
            { id: 'red', keywords: ['red', 'read'], type: 'color', val: '#EF4444' }, // Tailwind red-500
            { id: 'blue', keywords: ['blue', 'glue'], type: 'color', val: '#3B82F6' }, // Tailwind blue-500
            { id: 'green', keywords: ['green'], type: 'color', val: '#22C55E' }, // Tailwind green-500
            { id: 'yellow', keywords: ['yellow'], type: 'color', val: '#EAB308' }, // Tailwind yellow-500
            { id: 'orange', keywords: ['orange'], type: 'color', val: '#F97316' }, // Tailwind orange-500
            { id: 'purple', keywords: ['purple'], type: 'color', val: '#A855F7' }, // Tailwind purple-500
            { id: 'pink', keywords: ['pink'], type: 'color', val: '#EC4899' }, // Tailwind pink-500
            { id: 'black', keywords: ['black'], type: 'color', val: '#1F2937' }  // Tailwind gray-800
        ];

        // Sound Effects (Using reliable open URLs)
        // Note: For production, hosting your own MP3s in an 'assets' folder is safest.
        const SOUNDS = {
            pop: new Audio('https://www.soundjay.com/buttons/sounds/button-09.mp3'),
            win: new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'),
            lose: new Audio('https://www.soundjay.com/misc/sounds/fail-buzzer-01.mp3')
        };

        // --- STATE MANAGEMENT ---
        let state = {
            isPlaying: false,
            timer: GAME_DURATION,
            activeItems: [], // Items currently on screen
            recognition: null
        };

        let timerInterval;

        // --- INITIALIZATION ---
        window.onload = () => {
            // Check for Web Speech API support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Sorry, your browser doesn't support Voice Control. Please use Chrome or Safari.");
                return;
            }

            // Check Protocol for iOS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.getElementById('httpsWarning').classList.remove('hidden');
            }
        };

        // --- SPEECH RECOGNITION SETUP ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            state.recognition = new SpeechRecognition();
            state.recognition.continuous = true; // Keep listening
            state.recognition.interimResults = true; // Faster matching
            state.recognition.lang = 'en-US';

            state.recognition.onstart = () => {
                document.getElementById('micIcon').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('micIcon').classList.add('mic-active');
            };

            state.recognition.onend = () => {
                // If game is still playing, restart mic (iOS often stops it after silence)
                if (state.isPlaying) {
                    try {
                        state.recognition.start();
                    } catch(e) { console.log("Mic restart ignored"); }
                } else {
                    document.getElementById('micIcon').classList.replace('bg-green-500', 'bg-red-500');
                    document.getElementById('micIcon').classList.remove('mic-active');
                }
            };

            state.recognition.onresult = (event) => {
                // Get the latest result
                const lastResult = event.results[event.results.length - 1];
                const transcript = lastResult[0].transcript.toLowerCase().trim();
                
                // Visual feedback
                document.getElementById('transcript').textContent = transcript;

                // Check for matches
                checkMatch(transcript);
            };
        }

        // --- GAME LOGIC ---

        function startGame() {
            // 1. Initialize Audio Context (Must be done in user click for iOS)
            // We play sounds briefly at 0 volume to 'warm up' the iOS audio engine
            Object.values(SOUNDS).forEach(s => {
                s.volume = 0;
                s.play().catch(e => console.log("Audio play fail:", e));
                s.pause();
                s.currentTime = 0;
                s.volume = 1; // Reset volume for actual game
            });

            // 2. Initialize Speech
            if (!state.recognition) initSpeech();
            try {
                state.recognition.start();
            } catch (e) { console.log("Recognition already started"); }

            // 3. Reset State
            state.isPlaying = true;
            state.timer = GAME_DURATION;
            state.activeItems = JSON.parse(JSON.stringify(ASSETS)); // Deep copy

            // 4. UI Setup
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('timerDisplay').classList.remove('text-red-600');
            renderGrid();
            
            // 5. Start Timer
            clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                state.timer--;
                updateTimerDisplay();
                if (state.timer <= 0) {
                    gameOver(false);
                }
            }, 1000);
        }

        function resetGame() {
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            clearInterval(timerInterval);
            state.isPlaying = false;
            if(state.recognition) state.recognition.stop();
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; // Clear existing

            state.activeItems.forEach(item => {
                const el = document.createElement('div');
                el.id = `item-${item.id}`;
                el.className = 'vocab-card w-full aspect-square rounded-2xl flex items-center justify-center text-4xl shadow-sm border-4 border-white';
                
                if (item.type === 'color') {
                    el.style.backgroundColor = item.val;
                } else if (item.type === 'image') {
                    // Future proofing for images
                    el.style.backgroundImage = `url(${item.val})`;
                    el.style.backgroundSize = 'cover';
                    el.style.backgroundPosition = 'center';
                }

                // Debug helper: Show word on hover (or temporarily for testing)
                // el.title = item.id; 
                
                grid.appendChild(el);
            });
        }

        function checkMatch(spokenPhrase) {
            if (!state.isPlaying) return;

            // Simple keyword matching: does the spoken phrase contain the keyword?
            // We iterate backwards so we can splice safely if needed, 
            // though here we just look for IDs to remove.
            
            const matchedItemIndex = state.activeItems.findIndex(item => {
                return item.keywords.some(keyword => spokenPhrase.includes(keyword));
            });

            if (matchedItemIndex !== -1) {
                const item = state.activeItems[matchedItemIndex];
                
                // EXPLODE!
                const element = document.getElementById(`item-${item.id}`);
                if (element) {
                    // Visual
                    element.classList.add('exploding');
                    
                    // Audio
                    SOUNDS.pop.currentTime = 0;
                    SOUNDS.pop.play().catch(e => {});

                    // Data
                    state.activeItems.splice(matchedItemIndex, 1);

                    // Check Win
                    if (state.activeItems.length === 0) {
                        setTimeout(() => gameOver(true), 500); // Wait for animation
                    }
                }
            }
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            display.textContent = state.timer;
            if (state.timer <= 10) {
                display.classList.add('text-red-600');
            }
        }

        function gameOver(win) {
            state.isPlaying = false;
            clearInterval(timerInterval);
            if(state.recognition) state.recognition.stop();

            const screen = document.getElementById('endScreen');
            const title = document.getElementById('endTitle');
            const msg = document.getElementById('endMessage');

            screen.classList.remove('hidden');

            if (win) {
                title.textContent = "YOU WIN!";
                title.className = "text-6xl font-bold text-green-400 mb-4";
                msg.textContent = `Great job! You cleared the board in ${GAME_DURATION - state.timer} seconds.`;
                SOUNDS.win.play().catch(e => {});
            } else {
                title.textContent = "GAME OVER";
                title.className = "text-6xl font-bold text-red-500 mb-4";
                msg.textContent = "Time ran out! Try to be faster next time.";
                SOUNDS.lose.play().catch(e => {});
            }
        }
    </script>
</body>
</html>
