<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Word & Memory Pop!</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* iOS Safari prevents bounce scrolling which ruins game feel */
        body {
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* --- ANIMATIONS --- */

        /* Explosion (Word Pop) */
        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }
        .exploding {
            animation: explode 0.4s ease-out forwards;
            pointer-events: none;
        }

        /* Flip Out (Memory Pop - Hide) */
        @keyframes flipOut {
            0% { transform: perspective(600px) rotateY(0deg); opacity: 1; }
            50% { transform: perspective(600px) rotateY(90deg); opacity: 0.5; }
            100% { transform: perspective(600px) rotateY(180deg); opacity: 0; }
        }
        .flipped-hidden {
            animation: flipOut 0.6s ease-in forwards;
            pointer-events: none;
        }

        /* Pop In (Memory Pop - Reveal) */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .revealed {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Grid Item Styling */
        .vocab-card {
            transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Pulse animation for the mic icon when active */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .mic-active::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid white;
            top: 0;
            left: 0;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        /* Custom Select Styling */
        select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen overflow-hidden flex flex-col font-sans">

    <!-- TOP BAR: Controls & Status -->
    <div class="h-16 bg-white shadow-md flex items-center justify-between px-6 z-10 shrink-0">
        <div class="flex flex-col">
            <div class="text-xl font-bold text-gray-700 leading-tight">
                <span id="gameTitleDisplay">Word Pop!</span>
            </div>
            <span id="currentLevelName" class="text-xs font-normal text-gray-400">Select a level</span>
        </div>
        
        <!-- Controls Container -->
        <div class="flex items-center gap-4">
            
            <!-- Memory Pop Specific Control: Hide Button -->
            <button id="hideBtn" onclick="hideRandomItems()" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow transition transform active:scale-95">
                <i class="fa-solid fa-eye-slash mr-2"></i> Hide 4!
            </button>

            <!-- Timer Display (Only for Word Pop) -->
            <div id="timerContainer" class="flex items-center gap-2">
                <i class="fa-regular fa-clock text-gray-500"></i>
                <span id="timerDisplay" class="text-3xl font-bold text-blue-600 font-mono">45</span>
            </div>
        </div>
    </div>

    <!-- GAME AREA: Grid -->
    <div id="gameContainer" class="flex-1 p-4 relative flex items-center justify-center min-h-0">
        <!-- The Grid -->
        <div id="grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full max-w-5xl h-full max-h-full content-center">
            <!-- Items injected by JS -->
        </div>

        <!-- OVERLAYS -->
        
        <!-- Start Screen -->
        <div id="startScreen" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-50 backdrop-blur-sm px-4">
            
            <!-- Mode Switcher -->
            <div class="bg-gray-800 p-1 rounded-lg flex mb-6">
                <button id="modeWordPop" onclick="setMode('word-pop')" class="px-6 py-2 rounded-md font-bold text-sm transition-colors bg-blue-600 text-white shadow-sm">
                    Word Pop
                </button>
                <button id="modeMemoryPop" onclick="setMode('memory-pop')" class="px-6 py-2 rounded-md font-bold text-sm transition-colors text-gray-400 hover:text-white">
                    Memory Pop
                </button>
            </div>

            <h1 id="mainTitle" class="text-5xl font-extrabold text-white mb-2 tracking-wider text-center">WORD POP</h1>
            <p id="mainDesc" class="text-gray-300 mb-8 text-lg text-center max-w-md">Shout the words to pop them before time runs out!</p>
            
            <!-- Category Selector -->
            <div class="w-full max-w-xs mb-8">
                <label class="block text-gray-400 text-sm font-bold mb-2 ml-1">SELECT CATEGORY</label>
                <div class="relative">
                    <select id="categorySelect" class="block w-full bg-gray-700 border border-gray-600 hover:border-gray-500 text-white py-4 px-4 pr-8 rounded-xl shadow leading-tight focus:outline-none focus:shadow-outline text-lg">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>

            <button onclick="startGame()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-5 px-12 rounded-full text-2xl shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center gap-3 w-full max-w-xs justify-center">
                <i class="fa-solid fa-play"></i> START
            </button>
            
            <p id="httpsWarning" class="hidden text-red-400 mt-4 text-sm font-bold bg-red-900/50 p-2 rounded text-center">
                ⚠️ Warning: Microphone requires HTTPS or Localhost.
            </p>
        </div>

        <!-- Game Over Screen (Win/Lose) -->
        <div id="endScreen" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 px-4">
            <h2 id="endTitle" class="text-6xl font-bold text-white mb-4 text-center">GAME OVER</h2>
            <p id="endMessage" class="text-2xl text-gray-300 mb-8 text-center">Time's up!</p>
            <button onclick="resetGame()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-10 rounded-xl text-xl shadow-lg">
                Back to Menu
            </button>
        </div>
    </div>

    <!-- BOTTOM BAR: Speech & Manual Input -->
    <div class="h-14 bg-gray-800 flex items-center px-4 justify-between shrink-0 gap-4">
        
        <!-- Mic Status -->
        <div class="flex items-center gap-3 text-white shrink-0">
            <div id="micIcon" class="relative w-3 h-3 bg-red-500 rounded-full transition-colors"></div>
            <span class="hidden sm:inline text-xs text-gray-400 uppercase tracking-widest">Mic</span>
        </div>

        <!-- Manual Input (Useful for Memory Game) -->
        <div class="flex-1 max-w-md relative">
            <input type="text" id="manualInput" placeholder="Type or shout answer..." 
                   class="w-full bg-gray-700 text-white rounded-full py-1.5 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center placeholder-gray-500"
                   onkeydown="if(event.key === 'Enter') handleManualInput(this.value)">
        </div>

        <!-- Transcript Display -->
        <div class="hidden md:flex items-center gap-2 text-center max-w-xs overflow-hidden">
            <span class="text-gray-500 text-sm whitespace-nowrap">Heard:</span>
            <span id="transcript" class="text-white font-mono font-bold text-lg italic truncate">...</span>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const GAME_DURATION = 45; // Seconds (Word Pop)
        
        // --- DATA STRUCTURE ---
        const GAME_DATA = {
            colors: [
                { id: 'red', keywords: ['red', 'read'], type: 'color', val: '#EF4444' }, 
                { id: 'blue', keywords: ['blue', 'glue'], type: 'color', val: '#3B82F6' },
                { id: 'green', keywords: ['green'], type: 'color', val: '#22C55E' },
                { id: 'yellow', keywords: ['yellow'], type: 'color', val: '#EAB308' },
                { id: 'orange', keywords: ['orange'], type: 'color', val: '#F97316' },
                { id: 'purple', keywords: ['purple'], type: 'color', val: '#A855F7' },
                { id: 'pink', keywords: ['pink'], type: 'color', val: '#EC4899' },
                { id: 'black', keywords: ['black'], type: 'color', val: '#1F2937' }
            ],
            animals: [
                { id: 'dog', keywords: ['dog'], type: 'image', val: 'assets/dog.jpg' },
                { id: 'sheep', keywords: ['sheep'], type: 'image', val: 'assets/sheep.jpg' },
                { id: 'cat', keywords: ['cat'], type: 'image', val: 'assets/cat.jpg' },
                { id: 'tiger', keywords: ['tiger'], type: 'image', val: 'assets/tiger.jpg' },
                { id: 'lion', keywords: ['lion'], type: 'image', val: 'assets/lion.jpg' },
                { id: 'cow', keywords: ['cow'], type: 'image', val: 'assets/cow.jpg' },
                { id: 'duck', keywords: ['duck'], type: 'image', val: 'assets/duck.jpg' },
                { id: 'fox', keywords: ['fox'], type: 'image', val: 'assets/fox.jpg' }
            ],
            countries: [
                { id: 'south_africa', keywords: ['south africa'], type: 'image', val: 'assets/southafrica.png' },
                { id: 'japan', keywords: ['japan'], type: 'image', val: 'assets/japan.png' },
                { id: 'trinidad', keywords: ['trinidad', 'tobago'], type: 'image', val: 'assets/trinidad-and-tobago.png' },
                { id: 'jamaica', keywords: ['jamaica'], type: 'image', val: 'assets/jamaica.png' },
                { id: 'canada', keywords: ['canada'], type: 'image', val: 'assets/canada.png' },
                { id: 'uk', keywords: ['uk', 'united kingdom', 'britain', 'england'], type: 'image', val: 'assets/uk.png' },
                { id: 'new_zealand', keywords: ['new zealand'], type: 'image', val: 'assets/newzealand.png' },
                { id: 'australia', keywords: ['australia'], type: 'image', val: 'assets/australia.png' }
            ],
            shapes: [
                { id: 'triangle', keywords: ['triangle'], type: 'image', val: 'assets/triangle.png' },
                { id: 'rectangle', keywords: ['rectangle'], type: 'image', val: 'assets/rectangle.png' },
                { id: 'circle', keywords: ['circle'], type: 'image', val: 'assets/circle.png' },
                { id: 'square', keywords: ['square'], type: 'image', val: 'assets/square.png' },
                { id: 'heart', keywords: ['heart', 'love'], type: 'image', val: 'assets/heart.png' },
                { id: 'star', keywords: ['star'], type: 'image', val: 'assets/star.png' },
                { id: 'diamond', keywords: ['diamond'], type: 'image', val: 'assets/diamond.png' },
                { id: 'oval', keywords: ['oval'], type: 'image', val: 'assets/oval.png' }
            ]
        };

        // --- STATE MANAGEMENT ---
        let state = {
            mode: 'word-pop', // 'word-pop' or 'memory-pop'
            isPlaying: false,
            timer: GAME_DURATION,
            activeItems: [], // Items currently on screen
            hiddenItemIds: [], // IDs of items currently hidden in Memory mode
            recognition: null,
            currentCategory: 'colors'
        };

        let timerInterval;

        // --- INITIALIZATION ---
        try {
            const select = document.getElementById('categorySelect');
            if (select) {
                Object.keys(GAME_DATA).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' ');
                    select.appendChild(opt);
                });
            }
        } catch (e) { console.error("Error populating dropdown:", e); }

        window.onload = () => {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Voice Control not supported. Please use Chrome/Safari.");
            }
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.getElementById('httpsWarning').classList.remove('hidden');
            }
        };

        // --- MODE SWITCHING ---
        function setMode(mode) {
            state.mode = mode;
            
            // UI Updates
            const btnWord = document.getElementById('modeWordPop');
            const btnMem = document.getElementById('modeMemoryPop');
            const title = document.getElementById('mainTitle');
            const desc = document.getElementById('mainDesc');

            if (mode === 'word-pop') {
                btnWord.className = "px-6 py-2 rounded-md font-bold text-sm transition-colors bg-blue-600 text-white shadow-sm";
                btnMem.className = "px-6 py-2 rounded-md font-bold text-sm transition-colors text-gray-400 hover:text-white";
                title.textContent = "WORD POP";
                desc.textContent = "Shout the words to pop them before time runs out!";
            } else {
                btnWord.className = "px-6 py-2 rounded-md font-bold text-sm transition-colors text-gray-400 hover:text-white";
                btnMem.className = "px-6 py-2 rounded-md font-bold text-sm transition-colors bg-purple-600 text-white shadow-sm";
                title.textContent = "MEMORY POP";
                desc.textContent = "Hide items, then shout or type the missing ones to reveal them!";
            }
        }

        // --- SPEECH RECOGNITION ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            state.recognition = new SpeechRecognition();
            state.recognition.continuous = true; 
            state.recognition.interimResults = true; 
            state.recognition.lang = 'en-US';

            state.recognition.onstart = () => {
                document.getElementById('micIcon').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('micIcon').classList.add('mic-active');
            };

            state.recognition.onend = () => {
                if (state.isPlaying) {
                    try { state.recognition.start(); } catch(e) {}
                } else {
                    document.getElementById('micIcon').classList.replace('bg-green-500', 'bg-red-500');
                    document.getElementById('micIcon').classList.remove('mic-active');
                }
            };

            state.recognition.onresult = (event) => {
                const lastResult = event.results[event.results.length - 1];
                const transcript = lastResult[0].transcript.toLowerCase().trim();
                document.getElementById('transcript').textContent = transcript;
                processInput(transcript);
            };
        }

        function handleManualInput(text) {
            processInput(text.toLowerCase().trim());
            document.getElementById('manualInput').value = '';
        }

        // --- GAME LOGIC ---

        function startGame() {
            // Start Mic
            if (!state.recognition) initSpeech();
            try { state.recognition.start(); } catch (e) {}

            // Common Setup
            const selectedCat = document.getElementById('categorySelect').value || 'colors';
            state.currentCategory = selectedCat;
            const categoryItems = GAME_DATA[selectedCat];
            state.activeItems = JSON.parse(JSON.stringify(categoryItems));
            state.isPlaying = true;
            state.hiddenItemIds = [];

            // UI Reset
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('timerDisplay').classList.remove('text-red-600');
            document.getElementById('currentLevelName').textContent = selectedCat.toUpperCase();
            
            renderGrid();

            if (state.mode === 'word-pop') {
                // WORD POP SETUP
                document.getElementById('gameTitleDisplay').textContent = "Word Pop!";
                document.getElementById('timerContainer').classList.remove('hidden');
                document.getElementById('hideBtn').classList.add('hidden');
                
                state.timer = GAME_DURATION;
                clearInterval(timerInterval);
                updateTimerDisplay();
                timerInterval = setInterval(() => {
                    state.timer--;
                    updateTimerDisplay();
                    if (state.timer <= 0) gameOver(false);
                }, 1000);

            } else {
                // MEMORY POP SETUP
                document.getElementById('gameTitleDisplay').textContent = "Memory Pop!";
                document.getElementById('timerContainer').classList.add('hidden'); // Hide timer
                document.getElementById('hideBtn').classList.remove('hidden'); // Show hide button
                clearInterval(timerInterval); // No timer in memory mode
            }
        }

        // --- MEMORY POP SPECIFIC FUNCTIONS ---

        function hideRandomItems() {
            if (state.activeItems.length < 4) return; // Safety check
            
            // Create a pool of indices
            let indices = Array.from(Array(state.activeItems.length).keys());
            // Shuffle
            indices.sort(() => Math.random() - 0.5);
            // Pick first 4
            const toHideIndices = indices.slice(0, 4);
            
            state.hiddenItemIds = []; // Reset hidden list
            
            toHideIndices.forEach(index => {
                const item = state.activeItems[index];
                state.hiddenItemIds.push(item.id);
                
                const el = document.getElementById(`item-${item.id}`);
                if (el) {
                    el.classList.add('flipped-hidden');
                }
            });

            // Disable button after hiding
            document.getElementById('hideBtn').classList.add('hidden');
        }

        function revealItem(itemId) {
            const el = document.getElementById(`item-${itemId}`);
            if (el) {
                // Remove hidden class, add reveal animation
                el.classList.remove('flipped-hidden');
                el.classList.add('revealed');
                
                // Remove from hidden list
                state.hiddenItemIds = state.hiddenItemIds.filter(id => id !== itemId);

                // Check Win for Memory Pop
                if (state.hiddenItemIds.length === 0) {
                    setTimeout(() => gameOver(true), 1000);
                }
            }
        }

        // --- COMMON LOGIC ---

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; 

            state.activeItems.forEach(item => {
                const el = document.createElement('div');
                el.id = `item-${item.id}`;
                el.className = 'vocab-card w-full aspect-square rounded-2xl flex items-center justify-center text-4xl shadow-sm border-4 border-white bg-white overflow-hidden relative backface-hidden';
                
                if (item.type === 'color') {
                    el.style.backgroundColor = item.val;
                } else if (item.type === 'image') {
                    el.style.backgroundImage = `url('${item.val}')`;
                    el.style.backgroundSize = 'contain';
                    el.style.backgroundRepeat = 'no-repeat';
                    el.style.backgroundPosition = 'center';
                }
                grid.appendChild(el);
            });
        }

        function processInput(spokenPhrase) {
            if (!state.isPlaying) return;

            if (state.mode === 'word-pop') {
                // WORD POP LOGIC: Find matches -> Remove them
                const matchedItemIndex = state.activeItems.findIndex(item => {
                    return item.keywords.some(keyword => spokenPhrase.includes(keyword));
                });

                if (matchedItemIndex !== -1) {
                    const item = state.activeItems[matchedItemIndex];
                    const element = document.getElementById(`item-${item.id}`);
                    if (element) {
                        element.classList.add('exploding');
                        state.activeItems.splice(matchedItemIndex, 1);
                        if (state.activeItems.length === 0) setTimeout(() => gameOver(true), 500);
                    }
                }
            } else {
                // MEMORY POP LOGIC: Find matches in HIDDEN list -> Reveal them
                const matchedHiddenItem = state.activeItems.find(item => {
                    // Check if this item is currently hidden AND matches the keyword
                    return state.hiddenItemIds.includes(item.id) && 
                           item.keywords.some(keyword => spokenPhrase.includes(keyword));
                });

                if (matchedHiddenItem) {
                    revealItem(matchedHiddenItem.id);
                }
            }
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            display.textContent = state.timer;
            if (state.timer <= 10) display.classList.add('text-red-600');
        }

        function resetGame() {
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            clearInterval(timerInterval);
            state.isPlaying = false;
            if(state.recognition) state.recognition.stop();
        }

        function gameOver(win) {
            state.isPlaying = false;
            clearInterval(timerInterval);
            if(state.recognition) state.recognition.stop();

            const screen = document.getElementById('endScreen');
            const title = document.getElementById('endTitle');
            const msg = document.getElementById('endMessage');

            screen.classList.remove('hidden');

            if (win) {
                title.textContent = "GREAT JOB!";
                title.className = "text-6xl font-bold text-green-400 mb-4 text-center";
                if (state.mode === 'word-pop') {
                    msg.textContent = `Cleared in ${GAME_DURATION - state.timer}s!`;
                } else {
                    msg.textContent = "You found all the missing items!";
                }
            } else {
                title.textContent = "GAME OVER";
                title.className = "text-6xl font-bold text-red-500 mb-4 text-center";
                msg.textContent = "Time's up!";
            }
        }
    </script>
</body>
</html>
