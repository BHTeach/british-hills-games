<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Word & Memory Pop!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* --- ANIMATIONS --- */
        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.8; filter: brightness(1.5); }
            100% { transform: scale(2); opacity: 0; }
        }
        .exploding {
            animation: explode 0.4s ease-out forwards;
            pointer-events: none;
        }

        @keyframes flipOut {
            0% { transform: perspective(600px) rotateY(0deg); opacity: 1; }
            100% { transform: perspective(600px) rotateY(180deg); opacity: 0; }
        }
        .flipped-hidden {
            animation: flipOut 0.5s ease-in forwards;
            pointer-events: none;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .revealed {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .vocab-card {
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .mic-active::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 4px solid #22c55e;
            top: 0; left: 0;
            animation: pulse-ring 1.5s infinite;
        }

        /* Confetti piece styling */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen overflow-hidden flex flex-col font-sans">

    <!-- TOP BAR -->
    <div class="h-20 bg-white border-b flex items-center justify-between px-6 z-10 shrink-0">
        <div class="flex flex-col">
            <h1 id="gameTitleDisplay" class="text-2xl font-black text-slate-800 tracking-tight">Word Pop!</h1>
            <span id="currentLevelName" class="text-xs font-bold text-blue-500 uppercase tracking-widest">Select Category</span>
        </div>
        
        <div class="flex items-center gap-4">
            <button id="hideBtn" onclick="hideRandomItems()" class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-5 rounded-full shadow-lg transition transform active:scale-95 flex items-center gap-2">
                <i class="fa-solid fa-ghost"></i> Hide 4!
            </button>

            <div id="timerContainer" class="flex items-center gap-3 bg-slate-100 px-4 py-2 rounded-2xl border border-slate-200">
                <i class="fa-regular fa-clock text-slate-400"></i>
                <span id="timerDisplay" class="text-2xl font-black text-slate-700 font-mono w-8 text-center">45</span>
            </div>
        </div>
    </div>

    <!-- GAME AREA -->
    <div id="gameContainer" class="flex-1 p-6 relative flex items-center justify-center min-h-0 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:20px_20px]">
        <div id="grid" class="grid grid-cols-2 md:grid-cols-4 gap-6 w-full max-w-4xl h-full max-h-[600px] content-center">
            <!-- Dynamic Grid Items -->
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="absolute inset-0 bg-white/95 flex flex-col items-center justify-center z-50 px-6 text-center">
            <div class="bg-slate-100 p-1.5 rounded-2xl flex mb-8">
                <button id="modeWordPop" onclick="setMode('word-pop')" class="px-8 py-3 rounded-xl font-bold transition-all bg-white text-blue-600 shadow-sm">Word Pop</button>
                <button id="modeMemoryPop" onclick="setMode('memory-pop')" class="px-8 py-3 rounded-xl font-bold transition-all text-slate-400 hover:text-slate-600">Memory Pop</button>
            </div>

            <h2 id="mainTitle" class="text-6xl font-black text-slate-800 mb-4 uppercase italic">Word Pop</h2>
            <p id="mainDesc" class="text-slate-500 mb-10 text-lg max-w-md font-medium leading-relaxed">Shout the words to pop them before time runs out!</p>
            
            <div class="w-full max-w-xs mb-10">
                <label class="block text-slate-400 text-xs font-black mb-3 tracking-widest uppercase">Choose Category</label>
                <select id="categorySelect" class="block w-full bg-white border-2 border-slate-200 text-slate-700 py-4 px-6 rounded-2xl shadow-sm focus:border-blue-500 focus:outline-none text-xl font-bold appearance-none cursor-pointer">
                    <!-- Loaded by JS -->
                </select>
            </div>

            <button onclick="startGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-black py-6 px-16 rounded-3xl text-3xl shadow-[0_10px_0_rgb(29,78,216)] transform transition hover:-translate-y-1 active:translate-y-1 active:shadow-none flex items-center gap-4">
                <i class="fa-solid fa-play"></i> START GAME
            </button>
            
            <p id="httpsWarning" class="hidden text-amber-600 mt-8 text-sm font-bold bg-amber-50 p-3 rounded-xl border border-amber-200">
                ‚ö†Ô∏è Voice requires a Secure Connection (HTTPS).
            </p>
        </div>

        <!-- End Screen -->
        <div id="endScreen" class="hidden absolute inset-0 bg-white/98 flex flex-col items-center justify-center z-50 px-6 text-center animate-in fade-in zoom-in duration-300">
            <div id="endEmoji" class="text-8xl mb-6">üéâ</div>
            <h2 id="endTitle" class="text-6xl font-black text-slate-800 mb-4">GREAT JOB!</h2>
            <p id="endMessage" class="text-2xl text-slate-500 mb-12 font-medium"></p>
            <button onclick="resetGame()" class="bg-slate-800 hover:bg-black text-white font-black py-5 px-12 rounded-2xl text-xl transition transform hover:scale-105 active:scale-95">
                Back to Menu
            </button>
        </div>
    </div>

    <!-- BOTTOM BAR -->
    <div class="h-20 bg-white border-t flex items-center px-6 justify-between shrink-0 gap-6">
        <div class="flex items-center gap-4">
            <div id="micIcon" class="relative w-5 h-5 bg-slate-200 rounded-full transition-all duration-300"></div>
            <div class="hidden sm:block">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Voice Input</p>
                <p id="micStatusText" class="text-xs font-bold text-slate-600">Standby</p>
            </div>
        </div>

        <div class="flex-1 max-w-lg relative">
            <input type="text" id="manualInput" placeholder="Type or shout the answer..." 
                   class="w-full bg-slate-100 border-2 border-transparent focus:border-blue-500 focus:bg-white text-slate-800 rounded-2xl py-3 px-6 transition-all text-center font-bold text-lg outline-none"
                   onkeydown="if(event.key === 'Enter') handleManualInput(this.value)">
        </div>

        <div class="hidden md:flex flex-col items-end">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Recognized</p>
            <span id="transcript" class="text-blue-600 font-black text-xl italic truncate max-w-[200px]">...</span>
        </div>
    </div>

    <script>
        const GAME_DURATION = 45;
        
        // Gentle, high-quality UI sounds
        const SOUNDS = {
            pop: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'), // Bubble pop
            win: new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'), // Happy chime
            lose: new Audio('https://assets.mixkit.co/active_storage/sfx/251/251-preview.mp3'),  // Gentle "uhoh"
            flip: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'), // Card swoosh
            tick: new Audio('https://assets.mixkit.co/active_storage/sfx/2567/2567-preview.mp3')  // Short click
        };

        const GAME_DATA = {
            colors: [
                { id: 'red', keywords: ['red', 'read'], type: 'color', val: '#EF4444' }, 
                { id: 'blue', keywords: ['blue', 'glue'], type: 'color', val: '#3B82F6' },
                { id: 'green', keywords: ['green'], type: 'color', val: '#22C55E' },
                { id: 'yellow', keywords: ['yellow'], type: 'color', val: '#EAB308' },
                { id: 'orange', keywords: ['orange'], type: 'color', val: '#F97316' },
                { id: 'purple', keywords: ['purple'], type: 'color', val: '#A855F7' },
                { id: 'pink', keywords: ['pink'], type: 'color', val: '#EC4899' },
                { id: 'black', keywords: ['black'], type: 'color', val: '#1F2937' }
            ],
            animals: [
                { id: 'dog', keywords: ['dog'], type: 'emoji', val: 'üê∂' },
                { id: 'sheep', keywords: ['sheep', 'sleep'], type: 'emoji', val: 'üêë' },
                { id: 'cat', keywords: ['cat'], type: 'emoji', val: 'üê±' },
                { id: 'tiger', keywords: ['tiger'], type: 'emoji', val: 'üêØ' },
                { id: 'lion', keywords: ['lion'], type: 'emoji', val: 'ü¶Å' },
                { id: 'cow', keywords: ['cow'], type: 'emoji', val: 'üêÆ' },
                { id: 'duck', keywords: ['duck'], type: 'emoji', val: 'ü¶Ü' },
                { id: 'fox', keywords: ['fox'], type: 'emoji', val: 'ü¶ä' }
            ],
            shapes: [
                { id: 'triangle', keywords: ['triangle'], type: 'emoji', val: 'üî∫' },
                { id: 'circle', keywords: ['circle'], type: 'emoji', val: 'üî¥' },
                { id: 'square', keywords: ['square'], type: 'emoji', val: '‚¨õ' },
                { id: 'heart', keywords: ['heart', 'love'], type: 'emoji', val: '‚ù§Ô∏è' },
                { id: 'star', keywords: ['star'], type: 'emoji', val: '‚≠ê' },
                { id: 'diamond', keywords: ['diamond'], type: 'emoji', val: 'üíé' },
                { id: 'moon', keywords: ['moon'], type: 'emoji', val: 'üåô' },
                { id: 'sun', keywords: ['sun'], type: 'emoji', val: '‚òÄÔ∏è' }
            ]
        };

        let state = {
            mode: 'word-pop',
            isPlaying: false,
            timer: GAME_DURATION,
            activeItems: [],
            hiddenItemIds: [],
            recognition: null,
            currentCategory: 'colors'
        };

        let timerInterval;

        // Initialize UI
        function initApp() {
            const select = document.getElementById('categorySelect');
            Object.keys(GAME_DATA).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key.charAt(0).toUpperCase() + key.slice(1);
                select.appendChild(opt);
            });

            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                document.getElementById('httpsWarning').classList.remove('hidden');
            }
        }

        window.onload = initApp;

        function setMode(mode) {
            state.mode = mode;
            const btnWord = document.getElementById('modeWordPop');
            const btnMem = document.getElementById('modeMemoryPop');
            const title = document.getElementById('mainTitle');
            const desc = document.getElementById('mainDesc');

            if (mode === 'word-pop') {
                btnWord.className = "px-8 py-3 rounded-xl font-bold transition-all bg-white text-blue-600 shadow-sm";
                btnMem.className = "px-8 py-3 rounded-xl font-bold transition-all text-slate-400 hover:text-slate-600";
                title.textContent = "WORD POP";
                desc.textContent = "Shout the words to pop them before time runs out!";
            } else {
                btnWord.className = "px-8 py-3 rounded-xl font-bold transition-all text-slate-400 hover:text-slate-600";
                btnMem.className = "px-8 py-3 rounded-xl font-bold transition-all bg-white text-indigo-600 shadow-sm";
                title.textContent = "MEMORY POP";
                desc.textContent = "A card will vanish. Shout or type the missing one to reveal it!";
            }
        }

        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            state.recognition = new SpeechRecognition();
            state.recognition.continuous = true;
            state.recognition.interimResults = true;
            state.recognition.lang = 'en-US';

            state.recognition.onstart = () => {
                document.getElementById('micIcon').classList.add('bg-green-500', 'mic-active');
                document.getElementById('micStatusText').textContent = "Listening...";
                document.getElementById('micStatusText').className = "text-xs font-bold text-green-600 animate-pulse";
            };

            state.recognition.onend = () => {
                if (state.isPlaying) try { state.recognition.start(); } catch(e) {}
                else {
                    document.getElementById('micIcon').classList.remove('bg-green-500', 'mic-active');
                    document.getElementById('micStatusText').textContent = "Standby";
                    document.getElementById('micStatusText').className = "text-xs font-bold text-slate-600";
                }
            };

            state.recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
                document.getElementById('transcript').textContent = transcript;
                processInput(transcript);
            };
        }

        function startGame() {
            // Warm up audio for iOS
            Object.values(SOUNDS).forEach(s => {
                s.volume = 0; s.play().then(() => { s.pause(); s.volume = 1; }).catch(() => {});
            });

            if (!state.recognition) initSpeech();
            try { state.recognition.start(); } catch(e) {}

            const cat = document.getElementById('categorySelect').value;
            state.currentCategory = cat;
            state.activeItems = [...GAME_DATA[cat]];
            state.isPlaying = true;
            state.hiddenItemIds = [];
            state.timer = GAME_DURATION;

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('currentLevelName').textContent = cat;
            
            renderGrid();

            if (state.mode === 'word-pop') {
                document.getElementById('hideBtn').classList.add('hidden');
                document.getElementById('timerContainer').classList.remove('hidden');
                clearInterval(timerInterval);
                updateTimerDisplay();
                timerInterval = setInterval(() => {
                    state.timer--;
                    updateTimerDisplay();
                    if (state.timer % 10 === 0) playSound('tick');
                    if (state.timer <= 0) gameOver(false);
                }, 1000);
            } else {
                document.getElementById('hideBtn').classList.remove('hidden');
                document.getElementById('timerContainer').classList.add('hidden');
            }
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            state.activeItems.forEach(item => {
                const el = document.createElement('div');
                el.id = `item-${item.id}`;
                el.className = 'vocab-card w-full aspect-square rounded-3xl flex items-center justify-center text-6xl shadow-xl border-4 border-white bg-white overflow-hidden relative transition-transform hover:scale-105';
                
                if (item.type === 'color') {
                    el.style.backgroundColor = item.val;
                } else if (item.type === 'emoji') {
                    el.textContent = item.val;
                }
                grid.appendChild(el);
            });
        }

        function hideRandomItems() {
            if (state.activeItems.length < 4) return;
            playSound('flip');
            
            let indices = [...Array(state.activeItems.length).keys()].sort(() => Math.random() - 0.5);
            const toHide = indices.slice(0, 4);
            
            state.hiddenItemIds = [];
            toHide.forEach(idx => {
                const item = state.activeItems[idx];
                state.hiddenItemIds.push(item.id);
                document.getElementById(`item-${item.id}`).classList.add('flipped-hidden');
            });

            document.getElementById('hideBtn').classList.add('hidden');
        }

        function processInput(phrase) {
            if (!state.isPlaying) return;

            if (state.mode === 'word-pop') {
                const idx = state.activeItems.findIndex(item => 
                    item.keywords.some(k => phrase.includes(k))
                );

                if (idx !== -1) {
                    const item = state.activeItems[idx];
                    const el = document.getElementById(`item-${item.id}`);
                    if (el) {
                        el.classList.add('exploding');
                        playSound('pop');
                        state.activeItems.splice(idx, 1);
                        if (state.activeItems.length === 0) setTimeout(() => gameOver(true), 600);
                    }
                }
            } else {
                const item = state.activeItems.find(item => 
                    state.hiddenItemIds.includes(item.id) && 
                    item.keywords.some(k => phrase.includes(k))
                );

                if (item) {
                    const el = document.getElementById(`item-${item.id}`);
                    el.classList.remove('flipped-hidden');
                    el.classList.add('revealed');
                    playSound('pop');
                    state.hiddenItemIds = state.hiddenItemIds.filter(id => id !== item.id);
                    if (state.hiddenItemIds.length === 0) setTimeout(() => gameOver(true), 1000);
                }
            }
        }

        function handleManualInput(val) {
            processInput(val.toLowerCase().trim());
            document.getElementById('manualInput').value = '';
        }

        function updateTimerDisplay() {
            const d = document.getElementById('timerDisplay');
            d.textContent = state.timer;
            d.className = state.timer <= 10 ? "text-2xl font-black text-red-500 font-mono w-8 text-center animate-pulse" : "text-2xl font-black text-slate-700 font-mono w-8 text-center";
        }

        function gameOver(win) {
            state.isPlaying = false;
            clearInterval(timerInterval);
            if (state.recognition) state.recognition.stop();

            const screen = document.getElementById('endScreen');
            const title = document.getElementById('endTitle');
            const msg = document.getElementById('endMessage');
            const emoji = document.getElementById('endEmoji');

            screen.classList.remove('hidden');

            if (win) {
                emoji.textContent = "üèÜ";
                title.textContent = "FANTASTIC!";
                title.className = "text-6xl font-black text-green-500 mb-4";
                msg.textContent = state.mode === 'word-pop' ? `You popped them all in ${GAME_DURATION - state.timer} seconds!` : "Perfect memory! You found every hidden item.";
                playSound('win');
                createConfetti();
            } else {
                emoji.textContent = "‚è∞";
                title.textContent = "TIME'S UP";
                title.className = "text-6xl font-black text-slate-400 mb-4";
                msg.textContent = "Almost there! Give it another shot?";
                playSound('lose');
            }
        }

        function resetGame() {
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            state.isPlaying = false;
        }

        function playSound(key) {
            const s = SOUNDS[key];
            if (s) {
                s.currentTime = 0;
                s.play().catch(() => {});
            }
        }

        function createConfetti() {
            for(let i=0; i<50; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.top = '-10px';
                c.style.backgroundColor = ['#ff0', '#f0f', '#0ff', '#0f0'][Math.floor(Math.random()*4)];
                c.style.transform = `rotate(${Math.random()*360}deg)`;
                document.body.appendChild(c);
                
                const anim = c.animate([
                    { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
                    { transform: `translate(${(Math.random()-0.5)*200}px, 100vh) rotate(720deg)`, opacity: 0 }
                ], {
                    duration: 2000 + Math.random()*3000,
                    easing: 'cubic-bezier(0, .9, .57, 1)'
                });
                anim.onfinish = () => c.remove();
            }
        }
    </script>
</body>
</html>
